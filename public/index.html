<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mini Shop</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    header { position: sticky; top:0; background:#fff; border-bottom:1px solid #eee; padding:12px 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; padding:12px 16px; }
    .card { border:1px solid #eee; border-radius:10px; padding:12px; width:calc(50% - 12px); box-sizing:border-box; }
    .card h4 { margin:6px 0; font-size:16px; }
    .price { font-weight:600; }
    .actions { display:flex; gap:8px; margin-top:8px; }
    .pill { border:1px solid #ddd; border-radius:999px; padding:6px 10px; cursor:pointer; }
    .cart { position:fixed; bottom:0; left:0; right:0; border-top:1px solid #eee; background:#fff; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    .hidden { display:none; }
    label { display:block; margin:8px 0 4px; font-size:14px; }
    select, input { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; }
    #screen-checkout, #screen-profile { padding:12px 16px; }
    nav { display:flex; gap:8px; padding:8px 16px; border-top:1px solid #eee; }
    nav button { flex:1; padding:10px; }

    /* LOADING SCREEN ANIMATION */
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>

  <!-- LOADING SCREEN (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏) -->
  <div id="loadingScreen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  ">
    <div style="text-align: center; color: white;">
      <h1 style="font-size: 64px; margin: 0 0 20px 0;">üçî</h1>
      <h2 style="margin: 0; font-size: 28px; font-weight: 600;">Mini Shop</h2>
      <p style="margin: 15px 0 0 0; font-size: 14px; opacity: 0.85; letter-spacing: 0.5px;">–ü–æ–¥–æ–∂–¥–∏—Ç–µ, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
      <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
        <div style="width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
        <div style="width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 1.5s infinite 0.3s;"></div>
        <div style="width: 10px; height: 10px; background: white; border-radius: 50%; animation: pulse 1.5s infinite 0.6s;"></div>
      </div>
    </div>
  </div>

  <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (—Å–∫—Ä—ã—Ç–æ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏) -->
  <div id="app" style="display: none;">

    <header>
      <strong>Mini Shop</strong>
      <div id="tg-hint" style="font-size:12px; color:#666"></div>
    </header>

    <div id="screen-catalog">
      <div class="row" id="categories"></div>
      <div class="row" id="products"></div>
    </div>

    <div id="screen-checkout" class="hidden">
      <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>

      <label>–ó–æ–Ω–∞/–≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
      <select id="delivery-zone">
        <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑ (0 ‚ÇΩ)</option>
        <option value="zone1">–ó–æ–Ω–∞ 1 (+100 ‚ÇΩ)</option>
        <option value="zone2">–ó–æ–Ω–∞ 2 (+200 ‚ÇΩ)</option>
      </select>

      <label>–°–ø–æ—Å–æ–±</label>
      <select id="delivery-method">
        <option value="courier">–ö—É—Ä—å–µ—Ä</option>
        <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
      </select>

      <div id="address-wrap">
        <label>–ê–¥—Ä–µ—Å (–¥–ª—è –∫—É—Ä—å–µ—Ä–∞)</label>
        <input id="address" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞"/>
      </div>

      <h4>–ò—Ç–æ–≥–æ: <span id="total-sum">0</span> ‚ÇΩ</h4>
      <button id="btn-place" class="pill">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <div id="screen-profile" class="hidden">
      <h3>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h3>
      <div id="profile"></div>
      <h4>–ó–∞–∫–∞–∑—ã</h4>
      <div id="orders"></div>
    </div>

    <div class="cart" id="cart-bar">
      <div><strong>–ö–æ—Ä–∑–∏–Ω–∞:</strong> <span id="cart-count">0</span> –ø–æ–∑.</div>
      <div><strong><span id="cart-sum">0</span> ‚ÇΩ</strong></div>
      <div class="actions">
        <button id="to-checkout" class="pill">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
        <button id="to-profile" class="pill">–ü—Ä–æ—Ñ–∏–ª—å</button>
      </div>
    </div>

    <nav>
      <button id="tab-catalog">–ö–∞—Ç–∞–ª–æ–≥</button>
      <button id="tab-checkout">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</button>
      <button id="tab-profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
    </nav>

  </div><!-- –ö–æ–Ω–µ—Ü #app -->

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.expand(); document.getElementById('tg-hint').textContent = 'Mini App –æ—Ç–∫—Ä—ã—Ç –≤–Ω—É—Ç—Ä–∏ Telegram'; }
    else { document.getElementById('tg-hint').textContent = '–ó–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'; }

    const state = { user:null, categories:[], products:[], cart:[], deliveryFee:0 };

    const scrCatalog = document.getElementById('screen-catalog');
    const scrCheckout = document.getElementById('screen-checkout');
    const scrProfile = document.getElementById('screen-profile');
    function show(screen){ [scrCatalog,scrCheckout,scrProfile].forEach(el=>el.classList.add('hidden')); screen.classList.remove('hidden'); }

    document.getElementById('tab-catalog').onclick = () => show(scrCatalog);
    document.getElementById('tab-checkout').onclick = () => show(scrCheckout);
    document.getElementById('tab-profile').onclick = () => show(scrProfile);

    async function bootstrap(){
      const initData = tg?.initData || '';
      
      try {
        const res = await fetch('/api/bootstrap',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({initData}) });
        const data = await res.json();
        state.user = data.user;
        
        if (!data.products || !data.products.length) {
          console.log('No products in bootstrap, fetching from /api/menu');
          const menuRes = await fetch('/api/menu');
          const menu = await menuRes.json();
          state.categories = menu.categories || [];
          state.products = menu.products || [];
          console.log('Loaded menu from /api/menu:', state.products.length, 'products');
        } else {
          state.categories = data.categories;
          state.products = data.products;
        }
        
        renderCategories();
        renderProducts(state.products);
        renderProfile(data.user);
        renderOrders(data.orders || []);
        
        // –°–ö–†–´–í–ê–ï–ú LOADING SCREEN –ò –ü–û–ö–ê–ó–´–í–ê–ï–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
        const loadingScreen = document.getElementById('loadingScreen');
        const app = document.getElementById('app');
        if (loadingScreen) loadingScreen.style.display = 'none';
        if (app) app.style.display = 'block';
        
        console.log('Bootstrap complete:', state.products.length, 'products loaded');
      } catch (err) {
        console.error('Bootstrap error:', err);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
        const app = document.getElementById('app');
        if (app) app.style.display = 'block';
      }
    }

    function renderCategories(){
      const wrap = document.getElementById('categories'); wrap.innerHTML = '';
      state.categories.forEach(c=>{
        const d = document.createElement('div');
        d.className='pill'; d.textContent=c.name;
        d.onclick=()=>renderProducts(state.products.filter(p=>p.categoryId===c.id));
        wrap.appendChild(d);
      });
      const all = document.createElement('div'); all.className='pill'; all.textContent='–í—Å–µ';
      all.onclick=()=>renderProducts(state.products); wrap.prepend(all);
    }

    function renderProducts(list){
      const wrap=document.getElementById('products'); wrap.innerHTML='';
      list.forEach(p=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <h4>${p.name}</h4>
          <div class="price">${p.price} ‚ÇΩ</div>
          <div style="font-size:12px;color:#666">${p.categoryName||''}</div>
          <div class="actions">
            <button class="pill" data-id="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>`;
        card.querySelector('button').onclick=()=>addToCart(p);
        wrap.appendChild(card);
      });
    }

    function addToCart(p){
      const item=state.cart.find(i=>i.id===p.id);
      if(item) item.qty++; else state.cart.push({id:p.id,name:p.name,price:p.price,qty:1});
      updateCartBar();
    }
    
    function updateCartBar(){
      const count=state.cart.reduce((s,i)=>s+i.qty,0);
      const sum=state.cart.reduce((s,i)=>s+i.qty*i.price,0)+state.deliveryFee;
      document.getElementById('cart-count').textContent=count;
      document.getElementById('cart-sum').textContent=sum;
      document.getElementById('total-sum').textContent=sum;
    }

    const selectZone=document.getElementById('delivery-zone');
    const selectMethod=document.getElementById('delivery-method');
    const addressWrap=document.getElementById('address-wrap');
    function recalcDelivery(){
      const zone=selectZone.value; const method=selectMethod.value;
      addressWrap.style.display=(method==='courier')?'block':'none';
      let fee=0; if(method==='courier'){ if(zone==='zone1') fee=100; if(zone==='zone2') fee=200; }
      state.deliveryFee=fee; updateCartBar();
    }
    selectZone.onchange=recalcDelivery; selectMethod.onchange=recalcDelivery; recalcDelivery();

    document.getElementById('btn-place').onclick=async()=>{
      const initData=tg?.initData||'';
      const payload={ initData, items:state.cart, delivery:{ method:selectMethod.value, zone:selectZone.value, address:document.getElementById('address').value||null }};
      const res=await fetch('/api/orders',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      const data=await res.json();
      if(data.ok){ alert('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω #'+data.orderNumber); state.cart=[]; updateCartBar(); show(scrProfile); await loadOrders(); }
      else { alert('–û—à–∏–±–∫–∞: '+data.error); }
    };
    document.getElementById('to-checkout').onclick=()=>show(scrCheckout);
    document.getElementById('to-profile').onclick=()=>show(scrProfile);

    async function loadOrders(){ const r=await fetch('/api/orders'); const d=await r.json(); renderOrders(d.orders||[]); }
    
    function renderProfile(user){ const el=document.getElementById('profile'); if(!user){ el.textContent='–ì–æ—Å—Ç—å'; return; }
      el.innerHTML=`<div>–ü—Ä–∏–≤–µ—Ç, ${user.first_name||'–¥—Ä—É–≥'}!</div><div style="font-size:12px;color:#666">–í–∞—à Telegram ID: ${user.id}</div>`;
    }
    
    function renderOrders(orders){ const el=document.getElementById('orders'); el.innerHTML='';
      orders.forEach(o=>{ const d=document.createElement('div'); d.className='card';
        d.innerHTML=`<div><strong>‚Ññ${o.number}</strong> ‚Äî ${o.total} ‚ÇΩ ‚Äî ${o.status}</div><div style="font-size:12px;color:#666">${new Date(o.createdAt).toLocaleString()}</div>`;
        el.appendChild(d);
      });
    }

    bootstrap().catch(err=>alert('Bootstrap error: '+err.message));
  </script>

</body>
</html>
